<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATS Babel - Procesador de CV</title>
    <style>
        /* --- Estilos (iguales que la versión anterior) --- */
        :root {
            --primary-color: #0052cc; --secondary-color: #f4f5f7; --text-color: #172b4d;
            --border-color: #dfe1e6; --error-color: #de350b; --success-color: #00875a;
            --warning-color: #ffab00; --disabled-color: #a5adba; --white: #ffffff;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --border-radius: 4px; --input-padding: 0.75rem; --spacing: 1rem;
        }
        body {
            font-family: var(--font-family); background-color: var(--secondary-color); color: var(--text-color);
            margin: 0; padding: var(--spacing); display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
        }
        .container {
            background-color: var(--white); border-radius: var(--border-radius); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: calc(var(--spacing) * 1.5); width: 100%; max-width: 750px; margin-top: var(--spacing); margin-bottom: var(--spacing); box-sizing: border-box;
        }
        h1 { color: var(--primary-color); text-align: center; margin-bottom: calc(var(--spacing) * 1.5); font-size: 1.5rem; font-weight: 600; }
        h2 { font-size: 1.1rem; color: #5e6c84; margin-top: calc(var(--spacing) * 1.5); margin-bottom: var(--spacing); padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
         .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing); margin-bottom: var(--spacing); }
        .form-group { display: flex; flex-direction: column; }
        .full-width { grid-column: 1 / -1; }
        label { font-weight: 600; margin-bottom: 0.5rem; font-size: 0.875rem; color: #42526e; }
        input[type="text"], input[type="email"], input[type="url"], input[type="file"], select, textarea, .multiselect-input {
            padding: var(--input-padding); border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.95rem;
            width: 100%; box-sizing: border-box; transition: border-color 0.2s ease, box-shadow 0.2s ease; background-color: #fafbfc;
        }
        input:focus, select:focus, textarea:focus, .multiselect-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.2); background-color: var(--white); }
        input[type="file"] { padding: 0.5rem; background-color: var(--white); }
        textarea { min-height: 80px; resize: vertical; }
        .input-group { display: flex; gap: 1.5rem; margin-bottom: var(--spacing); }
        .input-group label { font-weight: normal; display:flex; align-items:center; cursor: pointer;}
        .input-group input[type="radio"] { margin-right: 0.5rem; }
        .input-option { display: none; } .input-option.active { display: block; }
        button {
            background-color: var(--primary-color); color: var(--white); padding: calc(var(--input-padding) * 1.1) calc(var(--spacing) * 1.5);
            border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1rem; font-weight: 600;
            transition: background-color 0.2s ease, box-shadow 0.2s ease; width: 100%; text-align: center;
        }
        button:hover:not(:disabled) { background-color: #003e99; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:disabled { background-color: #ebecf0; color: var(--disabled-color); cursor: not-allowed; border: 1px solid var(--border-color);}
        .button-secondary { background-color: #6c757d; }
        .button-secondary:hover:not(:disabled) { background-color: #5a6268; }
        .button-group { display: flex; gap: var(--spacing); margin-top: calc(var(--spacing) * 1.5); }
        .status-message { margin-top: var(--spacing); padding: var(--input-padding); border-radius: var(--border-radius); text-align: center; font-weight: 500; font-size: 0.9rem; border: 1px solid transparent; }
        .status-message.error { background-color: #ffebe6; color: var(--error-color); border-color: #ffbdad;}
        .status-message.success { background-color: #e3fcef; color: var(--success-color); border-color: #abf5d1;}
        .status-message.loading { background-color: #deebff; color: var(--primary-color); border-color: #b3d4ff;}
        .status-message.warning { background-color: #fff0b3; color: #ff8b00; border-color: var(--warning-color);}
        .multiselect-container { position: relative; }
        .multiselect-dropdown { display: none; position: absolute; background-color: white; border: 1px solid var(--border-color); border-radius: var(--border-radius); max-height: 200px; overflow-y: auto; width: 100%; z-index: 10; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 2px; }
        .multiselect-dropdown.show { display: block; }
        .multiselect-option { padding: 0.6rem var(--input-padding); cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid var(--secondary-color); }
        .multiselect-option:last-child { border-bottom: none; }
        .multiselect-option:hover { background-color: var(--secondary-color); }
        .multiselect-selected-list { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; min-height: 20px; }
        .multiselect-selected-item { background-color: #e0e0e0; color: var(--text-color); padding: 0.3rem 0.6rem; border-radius: 1rem; font-size: 0.8rem; display: flex; align-items: center; }
        .multiselect-remove-btn { background: none; border: none; color: #6b778c; margin-left: 0.4rem; cursor: pointer; padding: 0; font-size: 1.1rem; line-height: 1; font-weight: bold; }
        hr { grid-column: 1 / -1; border: none; border-top: 1px solid var(--border-color); margin: calc(var(--spacing) * 1.5) 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="main-title">Analizar CV</h1>

        <form id="ats-form">
            <div class="form-group full-width">
                <label>Fuente del Candidato:</label>
                <div class="input-group">
                    <label><input type="radio" name="source_option" value="cv" checked> Subir CV (PDF/DOCX)</label>
                    <label><input type="radio" name="source_option" value="linkedin"> URL de LinkedIn (Pública)</label>
                </div>
                <div id="cv-input-option" class="input-option active">
                    <label for="cv-file">Seleccionar archivo:</label>
                    <input type="file" id="cv-file" name="file" accept=".pdf,.doc,.docx">
                </div>
                <div id="linkedin-input-option" class="input-option">
                    <label for="linkedin-url-input">Pegar URL:</label>
                    <input type="url" id="linkedin-url-input" name="linkedin_url" placeholder="https://linkedin.com/in/nombreusuario">
                </div>
            </div>

            <hr>

            <h2>Datos del Candidato <span style="font-weight:normal; font-size: 0.8em;">(La IA rellenará/actualizará estos campos)</span></h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="nombre_apellido">Nombre y Apellido *</label>
                    <input type="text" id="nombre_apellido" name="nombre_apellido" required placeholder="Ej: Ana García López">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="Ej: ana.garcia@email.com">
                </div>
                <div class="form-group">
                    <label for="phone">Teléfono</label>
                    <input type="text" id="phone" name="phone" placeholder="+34600112233">
                </div>
                <div class="form-group">
                    <label for="location">Ubicación</label>
                    <input type="text" id="location" name="location" placeholder="Ej: Madrid, España">
                </div>
                <div class="form-group full-width">
                    <label for="linkedin_url">URL LinkedIn</label>
                    <input type="url" id="linkedin_url" name="linkedin_url" placeholder="https://linkedin.com/in/anagarcia/">
                </div>
                <div class="form-group">
                    <label for="current_company">Empresa Actual</label>
                    <input type="text" id="current_company" name="current_company" placeholder="Ej: Tech Solutions Inc. o Freelance">
                </div>
                 <div class="form-group">
                    <label for="skills">Skills (separado por comas)</label>
                    <input type="text" id="skills" name="skills" placeholder="Ej: Java, Python, React...">
                </div>
            </div>

            <hr>

             <h2>Información Adicional (Opcional)</h2>
            <div class="form-grid">
                 <div class="form-group">
                    <label for="stage">Stage</label>
                    <select id="stage" name="stage"></select>
                 </div>
                 <div class="form-group">
                    <label for="resolution">Resolution</label>
                    <select id="resolution" name="resolution"></select>
                </div>
                 <div class="form-group">
                    <label for="rejection_reason">Rejection Reason</label>
                    <select id="rejection_reason" name="rejection_reason"></select>
                 </div>
                 <div class="form-group">
                     <label for="source">Source</label>
                     <select id="source" name="source"></select>
                 </div>
                 <div class="form-group">
                     <label for="salary_expectation">Expectativa Salarial</label>
                     <input type="text" id="salary_expectation" name="salary_expectation" placeholder="Ej: 50,000 EUR Anuales Brutos">
                 </div>
                <div class="form-group">
                    <label for="gender">Gender</label>
                    <select id="gender" name="gender"></select>
                </div>
                <div class="form-group full-width">
                     <label for="languages-multiselect">Idiomas</label>
                     <div id="languages-multiselect" class="multiselect-container">
                        <input type="text" class="multiselect-input" placeholder="Buscar o seleccionar idiomas...">
                        <div class="multiselect-dropdown"></div>
                        <div class="multiselect-selected-list"></div>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="short_notes">Notas Cortas</label>
                    <textarea id="short_notes" name="short_notes" placeholder="Añade comentarios relevantes aquí..."></textarea>
                </div>
            </div>

             <div class="button-group">
                <button type="button" id="analyze-btn">1. Analizar con IA</button>
                <button type="button" id="submit-btn" disabled>2. Enviar a Notion</button>
            </div>

            <div id="status-message" class="status-message" style="display: none;"></div>

        </form>
    </div>

<script>
    // --- CONFIGURACIÓN ---
    const API_URL = "https://mi-super-ats.onrender.com"; // TU URL DE RENDER VERIFICADA
    // ---------------------

    // Selectores y estado
    const form = document.getElementById('ats-form');
    const analyzeBtn = document.getElementById('analyze-btn');
    const submitBtn = document.getElementById('submit-btn');
    const statusMessage = document.getElementById('status-message');
    const sourceOptions = document.querySelectorAll('input[name="source_option"]');
    const cvInputOption = document.getElementById('cv-input-option');
    const linkedinInputOption = document.getElementById('linkedin-input-option');
    const cvFileInput = document.getElementById('cv-file');
    const linkedinUrlInput = document.getElementById('linkedin-url-input');
    const mainTitle = document.getElementById('main-title');

    const fields = {
        nombre_apellido: document.getElementById('nombre_apellido'),
        email: document.getElementById('email'),
        phone: document.getElementById('phone'),
        location: document.getElementById('location'),
        linkedin_url: document.getElementById('linkedin_url'),
        current_company: document.getElementById('current_company'),
        skills: document.getElementById('skills'),
        salary_expectation: document.getElementById('salary_expectation'),
        stage: document.getElementById('stage'),
        resolution: document.getElementById('resolution'),
        rejection_reason: document.getElementById('rejection_reason'),
        source: document.getElementById('source'),
        gender: document.getElementById('gender'),
        short_notes: document.getElementById('short_notes'),
    };
    let currentFileInfo = null;
    let currentSourceType = 'cv';
    let availableLanguages = [];
    let selectedLanguages = [];
    const langContainer = document.getElementById('languages-multiselect');
    const langInput = langContainer.querySelector('.multiselect-input');
    const langDropdown = langContainer.querySelector('.multiselect-dropdown');
    const langSelectedList = langContainer.querySelector('.multiselect-selected-list');

    // Funciones Auxiliares
    function showStatus(message, type = 'loading') {
         statusMessage.textContent = message;
         statusMessage.className = `status-message ${type}`;
         statusMessage.style.display = 'block';
    }
    function hideStatus() { statusMessage.style.display = 'none'; }
    function setButtonsState(loading = false, analyzed = false) {
        analyzeBtn.disabled = loading;
        submitBtn.disabled = loading || !analyzed;
        analyzeBtn.textContent = loading ? 'Analizando...' : '1. Analizar con IA';
        submitBtn.textContent = loading ? 'Enviando...' : '2. Enviar a Notion';
        submitBtn.classList.toggle('button-secondary', submitBtn.disabled);
    }
    function populateSelect(selectElement, options) {
        selectElement.innerHTML = '';
        options.forEach(optionText => {
            const opt = document.createElement('option');
            opt.value = optionText;
            opt.textContent = optionText === "" ? '--- Selecciona ---' : optionText;
            selectElement.appendChild(opt);
        });
    }

    // Lógica Multi-select Idiomas
    function renderLangDropdown(filter = '') {
         langDropdown.innerHTML = '';
        const filteredLangs = availableLanguages.filter(lang =>
            lang.toLowerCase().includes(filter.toLowerCase()) && !selectedLanguages.includes(lang)
        );
        filteredLangs.forEach(lang => {
            const optionDiv = document.createElement('div');
            optionDiv.classList.add('multiselect-option');
            optionDiv.textContent = lang;
            optionDiv.dataset.value = lang;
            optionDiv.addEventListener('click', () => selectLanguage(lang));
            langDropdown.appendChild(optionDiv);
        });
        langDropdown.classList.toggle('show', filteredLangs.length > 0 || (filter.length > 0 && filteredLangs.length === 0));
        if (filter.length > 0 && filteredLangs.length === 0) {
             const noResult = document.createElement('div');
             noResult.classList.add('multiselect-option');
             noResult.textContent = 'No se encontraron idiomas';
             noResult.style.pointerEvents = 'none'; noResult.style.color = '#999';
             langDropdown.appendChild(noResult);
        }
    }
    function renderSelectedLanguages() {
        langSelectedList.innerHTML = '';
        selectedLanguages.forEach(lang => {
            const itemSpan = document.createElement('span');
            itemSpan.classList.add('multiselect-selected-item');
            itemSpan.textContent = lang;
            const removeBtn = document.createElement('button');
            removeBtn.classList.add('multiselect-remove-btn');
            removeBtn.innerHTML = '&times;';
            removeBtn.type = 'button';
            removeBtn.title = `Quitar ${lang}`;
            removeBtn.addEventListener('click', (e) => { e.stopPropagation(); deselectLanguage(lang); });
            itemSpan.appendChild(removeBtn);
            langSelectedList.appendChild(itemSpan);
        });
    }
    function selectLanguage(lang) {
        if (!selectedLanguages.includes(lang)) {
            selectedLanguages.push(lang); selectedLanguages.sort();
            renderSelectedLanguages(); langInput.value = ''; renderLangDropdown(); langDropdown.classList.remove('show');
            langInput.placeholder = "Buscar o seleccionar idiomas...";
        }
    }
     function deselectLanguage(lang) {
         selectedLanguages = selectedLanguages.filter(l => l !== lang); renderSelectedLanguages();
         if(langDropdown.classList.contains('show')) { renderLangDropdown(langInput.value); }
     }
    langInput.addEventListener('input', () => renderLangDropdown(langInput.value));
    langInput.addEventListener('focus', () => renderLangDropdown(langInput.value));
    langInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
             e.preventDefault();
             const firstOption = langDropdown.querySelector('.multiselect-option[data-value]');
             if (firstOption) { selectLanguage(firstOption.dataset.value); }
         }
     });
    document.addEventListener('click', (e) => { if (!langContainer.contains(e.target)) { langDropdown.classList.remove('show'); } });

    // Carga Inicial
    async function loadInitialOptions() {
         try {
            showStatus('Cargando opciones...', 'loading');
            // --- LLAMADA API CORREGIDA (sin /api/) ---
            const response = await fetch(`${API_URL}/options`);
            // ----------------------------------------
            if (!response.ok) {
                 let errorDetail = `Error ${response.status} (${response.statusText}) cargando opciones.`;
                 try { const errorData = await response.json(); errorDetail = errorData.detail || errorDetail; } catch (e) {}
                 throw new Error(errorDetail);
             }
            const options = await response.json();

            populateSelect(fields.stage, options.STAGE || []);
            populateSelect(fields.resolution, options.RESOLUTION || []);
            populateSelect(fields.rejection_reason, options.REJECTION_REASON || []);
            populateSelect(fields.source, options.SOURCE || []);
            populateSelect(fields.gender, options.GENDER || []);
            availableLanguages = options.LANGUAJE || [];
            renderLangDropdown();
            hideStatus();
        } catch (error) {
            showStatus(`Error crítico cargando opciones: ${error.message}. Recarga la página.`, 'error');
            console.error("Error fetching options:", error);
            analyzeBtn.disabled = true; submitBtn.disabled = true;
        }
    }

    // Manejadores de Eventos
    sourceOptions.forEach(radio => {
        radio.addEventListener('change', (e) => {
            currentSourceType = e.target.value;
            cvInputOption.classList.toggle('active', currentSourceType === 'cv');
            linkedinInputOption.classList.toggle('active', currentSourceType === 'linkedin');
            if (currentSourceType === 'cv') linkedinUrlInput.value = ''; else cvFileInput.value = '';
            currentFileInfo = null;
            Object.values(fields).forEach(field => {
                 if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') field.value = '';
                 else if (field.tagName === 'SELECT') field.selectedIndex = 0;
            });
            selectedLanguages = []; renderSelectedLanguages();
            setButtonsState(false, false);
            hideStatus();
        });
     });

    analyzeBtn.addEventListener('click', async () => {
         hideStatus(); setButtonsState(true, false); currentFileInfo = null;
        const formData = new FormData(); let body = null;

        if (currentSourceType === 'cv') {
            const file = cvFileInput.files[0];
            if (!file) { showStatus('Selecciona un archivo CV.', 'error'); setButtonsState(false, false); return; }
            formData.append('file', file); body = formData;
        } else {
             const url = linkedinUrlInput.value.trim();
            if (!url) { showStatus('Introduce una URL de LinkedIn.', 'error'); setButtonsState(false, false); return; }
             try { new URL(url); } catch { showStatus('URL de LinkedIn inválida.', 'error'); setButtonsState(false, false); return; }
            formData.append('linkedin_url', url); body = formData;
        }

        try {
            showStatus('Analizando con IA...', 'loading');
            // --- LLAMADA API CORREGIDA (sin /api/) ---
            const response = await fetch(`${API_URL}/process`, { method: 'POST', body: body });
            // ----------------------------------------
            const data = await response.json();
            if (!response.ok) { throw new Error(data.detail || `Error del servidor: ${response.status}`); }

            const extracted = data.extracted_data || {};
            fields.nombre_apellido.value = extracted.nombre_apellido || '';
            fields.email.value = extracted.email || '';
            fields.phone.value = extracted.phone || '';
            fields.location.value = extracted.location || '';
            fields.linkedin_url.value = extracted.linkedin_url || '';
            fields.current_company.value = extracted.current_company || '';
            fields.skills.value = (extracted.skills || []).join(', ');
            if (fields.gender.value === "") {
                 fields.gender.value = extracted.gender || '';
            }

            const newLangs = extracted.languages || [];
            newLangs.forEach(lang => {
                 if (availableLanguages.includes(lang) && !selectedLanguages.includes(lang)) {
                     selectedLanguages.push(lang);
                 }
            });
            selectedLanguages.sort();
            renderSelectedLanguages();

            currentFileInfo = data.file_info;
            currentSourceType = data.source_type;

            let statusType = 'success';
            let message = 'Análisis OK. Revisa/edita antes de enviar.';
            if (data.duplicate_info && data.duplicate_info.exists) {
                statusType = 'warning';
                message = `EMAIL DUPLICADO (${fields.email.value}). Revisa/envía igualmente.`;
            }
            showStatus(message, statusType);
            setButtonsState(false, true);

        } catch (error) {
            showStatus(`Error análisis: ${error.message}`, 'error');
            console.error("Error detallado análisis:", error);
            setButtonsState(false, false);
        }
    });

    submitBtn.addEventListener('click', async () => {
        if (!fields.nombre_apellido.value.trim()) { showStatus('Nombre y Apellido obligatorio.', 'error'); fields.nombre_apellido.focus(); return; }
        hideStatus(); setButtonsState(true, true);

        const candidatePayload = {
            nombre_apellido: fields.nombre_apellido.value.trim(),
            email: fields.email.value.trim() || null,
            phone: fields.phone.value.trim(),
            location: fields.location.value.trim(),
            linkedin_url: fields.linkedin_url.value.trim() || null,
            current_company: fields.current_company.value.trim(),
            skills: fields.skills.value ? fields.skills.value.split(',').map(s => s.trim()).filter(s => s) : [],
            salary_expectation: fields.salary_expectation.value.trim(),
            stage: fields.stage.value,
            resolution: fields.resolution.value,
            rejection_reason: fields.rejection_reason.value,
            source: fields.source.value,
            gender: fields.gender.value,
            languages: selectedLanguages,
            short_notes: fields.short_notes.value.trim(),
            file_info: currentFileInfo,
            source_type: currentSourceType
        };

        const callConfirmCreate = async (force = false) => {
             try {
                 showStatus('Enviando a Notion...', 'loading');
                 // --- LLAMADA API CORREGIDA (sin /api/) ---
                 const response = await fetch(`${API_URL}/candidates/confirm-create`, {
                 // ----------------------------------------
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ candidate_data: candidatePayload, force_create_duplicate: force })
                });
                const data = await response.json();
                 if (!response.ok) {
                    if (response.status === 409) {
                        if (confirm(`EMAIL DUPLICADO:\n${data.detail}\n\n¿Crear igualmente?`)) { await callConfirmCreate(true); }
                        else { showStatus('Creación cancelada.', 'warning'); setButtonsState(false, true); }
                    } else { throw new Error(data.detail || `Error servidor: ${response.status}`); }
                 } else {
                    showStatus(data.message || 'Éxito al enviar a Notion.', 'success');
                    if (data.notion_url) { window.open(data.notion_url, '_blank'); }
                     // Limpiar campos clave
                     fields.nombre_apellido.value = ''; fields.email.value = ''; fields.phone.value = ''; fields.location.value = '';
                     fields.linkedin_url.value = ''; fields.current_company.value = ''; fields.skills.value = '';
                     fields.salary_expectation.value = ''; fields.short_notes.value = '';
                     cvFileInput.value = ''; linkedinUrlInput.value = ''; currentFileInfo = null;
                     selectedLanguages = []; renderSelectedLanguages();
                     // Resetear dropdowns
                     fields.stage.selectedIndex = 0; fields.resolution.selectedIndex = 0; fields.rejection_reason.selectedIndex = 0;
                     fields.source.selectedIndex = 0; fields.gender.selectedIndex = 0;
                     
                     setButtonsState(false, false);
                }
            } catch (error) {
                showStatus(`Error envío Notion: ${error.message}`, 'error');
                console.error("Error detallado envío:", error);
                setButtonsState(false, true);
Posso ajudá-lo a analisar esse código ou a fazer alguma modificação? Por favor, me diga o que você precisa.
            }
        };
        await callConfirmCreate(false); // Llamada inicial
    });

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
        loadInitialOptions();
        setButtonsState(false, false);
        mainTitle.textContent = "Analizar CV"; // Asegurar título correcto
    });

</script>
</body>
</html>
